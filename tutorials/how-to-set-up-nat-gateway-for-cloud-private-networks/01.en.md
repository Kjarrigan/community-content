---
SPDX-License-Identifier: MIT
path: "/templates/how-to-set-up-nat-gateway-for-cloud-private-networks"
slug: "how-to-setup-nat-gateway-for-cloud-private-networks"
date: "2023-01-31"
title: "How to set up NAT gateway for cloud private networks"
short_description: "This tutorial will show how to set up NAT gateway for cloud private networks using only various Linux distributions."
tags: ["NAT", "Ubuntu"]
author: "Hetzner Online"
author_link: "https://github.com/hetzneronline"
author_img: "https://avatars.githubusercontent.com/u/30047064?s=200&v=4"
author_description: "-"
language: "en"
available_languages: ["en", "de"]
header_img: "header-x"
cta: "cloud"
---

## Introduction

This tutorial will show how to setup a generic NAT gateway for Cloud Servers via Cloud Private Networks.

If you are specifically interested in using pfSense then we have distinct Tutorial [here](https://community.hetzner.com/tutorials/how-to-route-cloudserver-over-private-network-using-pfsense-and-hcnetworks#configure-route-for-private-networking).

This tutorial is written for `Ubuntu 18.04, 20.04 and 22.04`, `Debian 10 and 11`, `CentOS 7, Stream 8, and Stream 9`, `Fedora 36 and 37` and `Rocky Linux 8 and 9`.

**Prerequisites**

* Hetzner Cloud account

## Step 1 - Creating the network and servers

The first step is to create a network. This can be done under:

`Networks > Create network`. 

The network can also be created later when ordering the servers.
![create_network](images/create-network.png)
The network needs to be selected here. 

Alternatively, you can assign the servers in your networks overview.
![create_server](images/create-server-with-network.png)

There are at least two servers needed.
The NAT server needs to have an IPv4 Address, the other doesn't.

## Step 2 - Add route to network

In order for our setup to work properly, we need to add the following route to the network:  

![](images/network-route.png)

The gateway should be the IP of the server we configured masquerading on.

## Step 3 - Configuring NAT

To configure the NAT we will use the following commands:

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```

To enable IP forwarding, since it is disabled on default.

```
iptables -t nat -A POSTROUTING -s '10.0.0.0/16' -o eth0 -j MASQUERADE
```

Let's look at the command in detail:

* iptables -> the programm we are using

* -t nat -> choose the table 'nat'

* -A POSTROUTING -> add a rule to postrouting

* -s '10.0.0.0/16' -> trarget packets from the source '10.0.0.0/16'

* -o eth0 -> output at 'eth0'

* -j MASQUERADE -> masquerade the packages with the 'routers' IP

To configure the clients we only need to add a default route. For example like this:

```
ip route add default via 10.0.0.1
```

### Step 3a - /network/interfaces # ifupdown

***Works with Debian 10, Debian 11, Ubuntu 18.04, Ubuntu 22.04***

First, the system needs to be updated:

```
apt update && apt upgrade -y
```

---

***Ubuntu 22.04 additionally requires:***

```
apt install ifupdown
```

---

This tutorial will show the steps using `vim`, which can be installed using: `apt install vim`

#### Step 3a.1 - NAT host

To make everything persistent, we open the following file:

```
vim /etc/network/interfaces
```

To enter the insert mode in `vim` press `i` and append the following to the file:

```
auto eth0
iface eth0 inet dhcp
    post-up echo 1 > /proc/sys/net/ipv4/ip_forward
    post-up   iptables -t nat -A POSTROUTING -s '10.0.0.0/16' -o eth0 -j MASQUERADE
```

To save the file, press `esc` to escape the insert mode and type `:x` or `:wq`.

#### Step 3a.2 - other hosts

Since we also want the route to be persistent we edit the following file:

```
vim /etc/network/interfaces
```

And add:

```
auto ens10
iface ens10 inet dhcp
    post-up ip route add default via 10.0.0.1
```

### Step 3b - netplan # networkd-dispatcher

***Works with Ubuntu 20.04***

First, the system needs to be updated:

```
apt update && apt upgrade -y
```

Ubuntu 20.04 uses `netplan` instead of `/etc/interfaces` on default. To achieve persistent configuration, the [networkd-dispatcher](https://gitlab.com/craftyguy/networkd-dispatcher) is being used.

As found in [netplan FAQ](https://netplan.io/faq), the `networkd-dispatcher` equivalent of `post-up` is placing a script in `/etc/networkd-dispatcher/routable.d/`. In this tutorial we call the script `50-masq` but the name doesn't matter:

#### Step 3b.1 - NAT host

Create the file:

```
vim /etc/networkd-dispatcher/routable.d/50-masq
```

and append:

```
#!/bin/sh

/bin/echo 1 > /proc/sys/net/ipv4/ip_forward
/sbin/iptables -t nat -A POSTROUTING -s '10.0.0.0/16' -o eth0 -j MASQUERADE
```

The following command is required to make the script executable, otherwise it will not work:

```
chmod +x /etc/networkd-dispatcher/routable.d/50-masq
```

#### Step 3b.2 - other hosts

Create the file:

```
vim /etc/networkd-dispatcher/routable.d/50-masq
```

and append:

```
#!/bin/sh

/sbin/ip route add default via 10.0.0.1
```

Finally, make it executable:

```
chmod +x /etc/networkd-dispatcher/routable.d/50-masq
```

### Step 3c - NetworkManager # dispacher.d

***Works with CentOS 7, CentOS Stream 8, CentOS Stream 9, Rocky Linux 8, Rocky Linux 8, Fedora 36, Fedora 37***

First, the system needs to be updated:

```
yum update -y && yum upgrade -y 
```

We use the `NetworkManager`'s `dispatcher.d` to run our scripts automated on start. This is done by placing the script into the folder `/etc/NetworkManager/dispatcher.d/`.  Here, the name determines the execution condition of the script. More information can be found [here](https://man.archlinux.org/man/NetworkManager-dispatcher.8.en). 

In this tutrorial we use the name `ifup-local` where `ifup` is the condition for the script to get executed.

#### Step 3c.1 - NAT host

---

***Fedora 36, Fedora 37 additionally require:***

```
yum install iptables -y
```

---

Create the file:

```
vi /etc/NetworkManager/dispatcher.d/ifup-local
```

and append:

```
#!/bin/sh

/bin/echo 1 > /proc/sys/net/ipv4/ip_forward
/sbin/iptables -t nat -A POSTROUTING -s '10.0.0.0/16' -o eth0 -j MASQUERADE
```

Finally, make it executable:

```
chmod +x /etc/NetworkManager/dispatcher.d/ifup-local
```

#### Step 3c.2 - other hosts

---

***CentOS Stream 8, CentOS Stream 9, Rocky Linux 8, Rocky Linux 9, Fedora 36, Fedora 37 additionally require:***

```
yum remove hc-utils -y
```

This also goes for other methods to add a route to the OS.

---

Create the file:

```
vi /etc/NetworkManager/dispatcher.d/ifup-local
```

and append:

```
#!/bin/sh

/sbin/ip route add default via 10.0.0.1
```

Finally, make it executable:

```
chmod +x /etc/NetworkManager/dispatcher.d/ifup-local
```

## Conclusion

If you followed all these steps, you have successfully configured your system to behave in your cloud private network as a NAT router.

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
